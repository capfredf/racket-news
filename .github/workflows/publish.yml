name: Publish

on:
  push:
    branches:
      - master

jobs:
  publish:
    runs-on: ubuntu-latest
    container: debian:stable-slim

    steps:
      - uses: actions/checkout@v2
      - run: |
          apt-get update
          apt-get install -y ca-certificates openssl uuid-dev make rsync
      - uses: Bogdanp/setup-racket@v0.9
        with:
          architecture: 'x64'      # (x64 or x86), ignored on Linux
          distribution: 'minimal'  # or 'minimal'
          variant: 'CS'            # or 'CS' for Racket-on-Chez
          version: '7.7'           # or 'current' for the latest snapshot
          packages: 'darwin, rosette'
      - run: make site
      - run: ./rememberme.sh
      - run: |
          mkdir /root/.ssh
          echo ${{ secrets.SSH_PRIVATE_KEY }} > /root/.ssh/id_rsa
          echo ${{ secrets.SSH_PUBLIC_KEY }} > /root/.ssh/id_rsa.pub
      - run: ssh root@racket-news.com echo "Hello RN!"
      - run: rsync -avz --delete public/ root@racket-news.com:/var/www/racket-news.com/
